- title 'Journal'

- content_for :sidebar do

  - if can? :create, Entry
    = link_to [:new, :entry], class: 'btn btn-success btn-block' do
      %i.fa.fa-inverse.fa-plus
      New Journal Entry

  %hr

  .panel.panel-default
    .panel-heading
      %h3.panel-title Search
    .panel-body
      = form_tag nil, method: :get, role: 'form' do
        .form-group
          = label_tag :ends_on, 'Date'
          = text_field_tag :ends_on, l(@ends_on), class: 'datepicker form-control'
        .form-group
          = label_tag :user
          = select nil, :user_id, current_user.users_whose_entries_i_can_edit.map { |user| [user.name, user.id] }, { selected: @entry_user.id.to_s }, { class: 'form-control' }
        - if can? :create, Entry
          .form-group
            = label_tag :tag
            = select nil, :tag, Entry.entry_tag_counts.pluck(:name).sort, { include_blank: 'Any tag', selected: params[:tag] }, { class: 'form-control' }
        .form-group
          = label_tag :term
          = text_field_tag :term, params[:term], class: 'form-control', :placeholder => 'Search'
        = submit_tag 'Search', class: 'btn btn-primary btn-block'

- if @entries.empty?
  %p.row Nothing yet.
- else
  - @entries.each do |entry|
    = div_for entry, class: 'row span12' do
      - if can? :edit, entry
        .btn-group.pull-right
          = link_to [:edit, entry], class: 'btn btn-small' do
            %i.fa.fa-edit
            Edit
          = link_to entry, class: 'btn btn-small', method: :delete, data: { confirm: 'Are you sure you want to delete this entry?' } do
            %i.fa.fa-trash-o
            Delete
      - if params[:term].present?
        %h3= link_to date_with_significant_time(entry.at), entry
        %p= entry.body.to_s[/\b.{0,55}#{params[:term].to_s.downcase}.{0,55}\b/i].gsub(/#{params[:term].to_s.downcase}/i, "<strong><em>#{params[:term]}</em></strong>").html_safe
      - else
        %h3= date_with_significant_time(entry.at)
        .body
          - if entry.entry_tags.present?
            - entry.entry_tag_list.each do |tag_name|
              .label.label-info.pull-right{ style: 'margin: 0 0.2em' }
                = link_to tag_name, entries_path(tag: tag_name)
          :markdown
            #{entry.body}

  %p.clearfix
    = paginate @entries
